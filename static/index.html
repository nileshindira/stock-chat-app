<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Carousel-Only Demo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#0b0f17; color:#e8eefc; }
    .shell { max-width:1100px; margin:0 auto; padding:20px; }
    .card-dark { background:#101826; border:1px solid rgba(255,255,255,.08); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    .muted { color: rgba(232,238,252,.72); }
    .chip { font-size:12px; padding:6px 10px; border-radius:999px; background: rgba(255,255,255,.06); }
    .sticky { position: sticky; bottom:0; background: linear-gradient(180deg, rgba(11,15,23,0), rgba(11,15,23,1) 35%); padding-top: 12px; }
    .btn-soft { background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); color:#e8eefc; }
    .btn-soft:hover { background: rgba(255,255,255,.12); }
    .carousel-control-prev, .carousel-control-next { width: 7%; }
    .item-card { background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:14px; }
    .title { font-weight:700; font-size:18px; }
    .value { font-weight:800; font-size:22px; letter-spacing:.2px; }
    .sub { font-size:13px; }
  </style>
</head>
<body>
  <div class="shell">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <div class="h4 mb-0">Carousel-Only Demo</div>
        <div class="muted">Type intent → backend returns only carousels → UI renders only carousels</div>
      </div>
      <div class="chip" id="wsStatus">WS: connecting…</div>
    </div>

    <div class="card card-dark p-3 mb-3">
      <div class="muted mb-2">Assistant</div>
      <div id="assistantText">Try: “show templates”, “show hotels in goa”, “show stocks”, “explore all”</div>
    </div>

    <div class="card card-dark p-3">
      <div class="muted mb-2">Results</div>
      <div id="results">
        <div class="muted">No carousels yet. Send a message.</div>
      </div>
    </div>

    <div class="sticky mt-3">
      <div class="card card-dark p-3">
        <div class="d-flex gap-2">
          <input id="chatInput" class="form-control form-control-lg" placeholder='Type: "show templates" / "show hotels" / "show stocks"'>
          <button id="sendBtn" class="btn btn-soft btn-lg">Send</button>
        </div>
        <div class="muted mt-2" style="font-size:12px;">Live numbers are random updates via WebSocket.</div>
      </div>
    </div>
  </div>

  <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastHost"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let ws;
    let subscribedItemIds = new Set();

    function toast(msg, ok=true) {
      const host = document.getElementById("toastHost");
      const el = document.createElement("div");
      el.className = "toast align-items-center text-bg-" + (ok ? "success":"danger") + " border-0";
      el.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${msg}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>`;
      host.appendChild(el);
      const t = new bootstrap.Toast(el, { delay: 2200 });
      t.show();
      el.addEventListener("hidden.bs.toast", () => el.remove());
    }

    function wsConnect() {
      const status = document.getElementById("wsStatus");
      const proto = location.protocol === "https:" ? "wss" : "ws";
      ws = new WebSocket(`${proto}://${location.host}/ws/live`);

      ws.onopen = () => {
        status.textContent = "WS: connected";
        status.className = "chip";
        wsSubscribe([...subscribedItemIds]);
      };

      ws.onclose = () => {
        status.textContent = "WS: disconnected";
        status.className = "chip";
        setTimeout(wsConnect, 800);
      };

      ws.onmessage = (ev) => {
        const msg = JSON.parse(ev.data);
        if (msg.type === "update") {
          const data = msg.data || {};
          for (const itemId of Object.keys(data)) {
            const v = data[itemId];
            const pv = document.querySelector(`[data-item="${itemId}"][data-k="primary"]`);
            const sv = document.querySelector(`[data-item="${itemId}"][data-k="secondary"]`);
            if (pv) pv.textContent = v.primary_value ?? "-";
            if (sv) sv.textContent = v.secondary_value ?? "-";
          }
        }
      };
    }

    function wsSubscribe(itemIds) {
      if (!ws || ws.readyState !== 1) return;
      ws.send(JSON.stringify({ type: "subscribe", item_ids: itemIds }));
    }

    async function sendChat() {
      const input = document.getElementById("chatInput");
      const msg = (input.value || "").trim();
      if (!msg) return;
      input.value = "";

      document.getElementById("assistantText").textContent = "Thinking…";

      const res = await fetch("/api/chat", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ message: msg })
      });
      const data = await res.json();
      document.getElementById("assistantText").textContent = data.assistant_text || "";

      renderCarousels(data.carousels || []);
    }

    function renderCarousels(carousels) {
      const root = document.getElementById("results");
      subscribedItemIds = new Set();

      if (!carousels.length) {
        root.innerHTML = `<div class="muted">No carousels.</div>`;
        return;
      }

      root.innerHTML = carousels.map((c, idx) => {
        const cid = `c_${idx}_${c.carousel_id}`;
        const indicators = (c.items || []).map((_, i) =>
          `<button type="button" data-bs-target="#${cid}" data-bs-slide-to="${i}" class="${i===0?'active':''}" aria-label="Slide ${i+1}"></button>`
        ).join("");

        const itemsHtml = (c.items || []).map((it, i) => {
          subscribedItemIds.add(it.id);

          const actionBtns = (it.actions || []).map(a =>
            `<button class="btn btn-soft btn-sm" onclick="doAction('${it.id}','${a.action}')">${a.label}</button>`
          ).join(" ");

          const badges = (it.badges || []).slice(0,3).map(b => `<span class="chip me-1">${b}</span>`).join("");

          return `
            <div class="carousel-item ${i===0?'active':''}">
              <div class="item-card">
                <div class="d-flex justify-content-between align-items-start gap-3">
                  <div>
                    <div class="title">${it.title}</div>
                    <div class="muted sub">${it.subtitle || ""}</div>
                    <div class="mt-2">${badges}</div>
                  </div>
                  <div class="text-end">
                    <div class="value" data-item="${it.id}" data-k="primary">${it.primary_value ?? "-"}</div>
                    <div class="muted sub" data-item="${it.id}" data-k="secondary">${it.secondary_value ?? "-"}</div>
                  </div>
                </div>
                <div class="d-flex gap-2 mt-3 flex-wrap">
                  ${actionBtns}
                </div>
              </div>
            </div>
          `;
        }).join("");

        return `
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-end mb-2">
              <div>
                <div class="h5 mb-0">${c.title}</div>
                <div class="muted">${c.subtitle || ""}</div>
              </div>
              <div class="muted">${(c.items || []).length} items</div>
            </div>

            <div id="${cid}" class="carousel slide" data-bs-ride="false" data-bs-touch="true">
              <div class="carousel-indicators">${indicators}</div>
              <div class="carousel-inner">${itemsHtml}</div>

              <button class="carousel-control-prev" type="button" data-bs-target="#${cid}" data-bs-slide="prev">
                <span class="carousel-control-prev-icon"></span>
                <span class="visually-hidden">Previous</span>
              </button>

              <button class="carousel-control-next" type="button" data-bs-target="#${cid}" data-bs-slide="next">
                <span class="carousel-control-next-icon"></span>
                <span class="visually-hidden">Next</span>
              </button>
            </div>
          </div>
        `;
      }).join("");

      wsSubscribe([...subscribedItemIds]);
    }

    async function doAction(itemId, action) {
      const res = await fetch("/api/action", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ item_id: itemId, action })
      });
      const data = await res.json();
      toast(data.message || "Action done", !!data.ok);
    }

    document.getElementById("sendBtn").addEventListener("click", sendChat);
    document.getElementById("chatInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendChat();
    });

    wsConnect();
  </script>
</body>
</html>
