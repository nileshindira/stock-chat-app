<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Stock Chat Carousel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #0b0f17; color: #e8eefc; }
    .app-shell { max-width: 1100px; margin: 0 auto; padding: 20px; }
    .card-dark {
      background: #101826;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .muted { color: rgba(232,238,252,.7); }
    .chip { font-size: 12px; padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,.06); }
    .price { font-size: 28px; font-weight: 700; letter-spacing: .3px; }
    .news-item { padding: 8px 0; border-top: 1px solid rgba(255,255,255,.06); }
    .news-item:first-child { border-top: 0; }
    .btn-soft { background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.12); color: #e8eefc; }
    .btn-soft:hover { background: rgba(255,255,255,.12); }
    .carousel-control-prev, .carousel-control-next { width: 8%; }
    .sticky-chat { position: sticky; bottom: 0; background: linear-gradient(180deg, rgba(11,15,23,0), rgba(11,15,23,1) 40%); padding-top: 14px; }
    .toast-container { z-index: 9999; }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <div class="h4 mb-0">Stock Chat</div>
        <div class="muted">Carousel-only stock cards + live demo ticks</div>
      </div>
      <div class="chip" id="wsStatus">WS: connecting…</div>
    </div>

    <div class="card card-dark p-3 mb-3">
      <div class="muted mb-2">Assistant</div>
      <div id="assistantText">Ask: “show top movers”, “show reliance”, “show tcs”, etc.</div>
    </div>

    <!-- Carousel container (ONLY display format) -->
    <div class="card card-dark p-3">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="muted">Carousel</div>
        <div class="muted" id="carouselMeta"></div>
      </div>

      <div id="carouselWrap">
        <div class="muted">No cards yet — send a chat message.</div>
      </div>
    </div>

    <!-- Chat input -->
    <div class="sticky-chat mt-3">
      <div class="card card-dark p-3">
        <div class="d-flex gap-2">
          <input id="chatInput" class="form-control form-control-lg" placeholder='Type e.g. "show top movers"'/>
          <button id="sendBtn" class="btn btn-soft btn-lg">Send</button>
        </div>
        <div class="muted mt-2" style="font-size: 12px;">Tip: buttons are demo orders. Prices are random live ticks.</div>
      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastHost"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let ws = null;
    let subscribedSymbols = [];
    let latestCards = [];

    function toast(msg, ok=true) {
      const id = "t" + Math.random().toString(16).slice(2);
      const host = document.getElementById("toastHost");
      const el = document.createElement("div");
      el.className = "toast align-items-center text-bg-" + (ok ? "success" : "danger") + " border-0";
      el.id = id;
      el.role = "alert";
      el.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${msg}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>`;
      host.appendChild(el);
      const t = new bootstrap.Toast(el, { delay: 2200 });
      t.show();
      el.addEventListener("hidden.bs.toast", () => el.remove());
    }

    function fmt(n) {
      if (n === null || n === undefined) return "-";
      return Number(n).toLocaleString();
    }

    function pctClass(p) {
      if (p > 0) return "text-success";
      if (p < 0) return "text-danger";
      return "muted";
    }

    function renderCarousel(cards) {
      latestCards = cards || [];
      const wrap = document.getElementById("carouselWrap");
      const meta = document.getElementById("carouselMeta");
      meta.textContent = latestCards.length ? (latestCards.length + " cards") : "";

      if (!latestCards.length) {
        wrap.innerHTML = `<div class="muted">No cards to show.</div>`;
        return;
      }

      const carouselId = "stockCarousel";
      const indicators = latestCards.map((_, i) => `
        <button type="button" data-bs-target="#${carouselId}" data-bs-slide-to="${i}" class="${i===0?'active':''}" aria-current="${i===0?'true':'false'}" aria-label="Slide ${i+1}"></button>
      `).join("");

      const items = latestCards.map((c, i) => {
        const cls = i===0 ? "carousel-item active" : "carousel-item";
        const pct = c.change_pct ?? 0;
        return `
          <div class="${cls}">
            <div class="p-2">
              <div class="d-flex justify-content-between align-items-start gap-3">
                <div>
                  <div class="h5 mb-1">${c.symbol}</div>
                  <div class="price">₹ <span data-sym="${c.symbol}" data-k="ltp">${fmt(c.ltp)}</span></div>
                  <div class="${pctClass(pct)}">
                    <span data-sym="${c.symbol}" data-k="change">${fmt(c.change)}</span>
                    (<span data-sym="${c.symbol}" data-k="change_pct">${fmt(pct)}</span>%)
                  </div>
                </div>

                <div class="text-end">
                  <div class="chip mb-2">VOL: <span data-sym="${c.symbol}" data-k="vol">${fmt(c.vol)}</span></div>
                  <div class="muted" style="font-size: 13px;">
                    H: <span data-sym="${c.symbol}" data-k="day_high">${fmt(c.day_high)}</span> &nbsp;•&nbsp;
                    L: <span data-sym="${c.symbol}" data-k="day_low">${fmt(c.day_low)}</span>
                  </div>
                </div>
              </div>

              <div class="d-flex gap-2 mt-3">
                <button class="btn btn-success w-50" onclick="order('${c.symbol}','BUY')">Buy</button>
                <button class="btn btn-danger w-50" onclick="order('${c.symbol}','SELL')">Sell</button>
              </div>

              <div class="mt-3">
                <div class="muted mb-1">News</div>
                <div>
                  ${(c.news || []).slice(0,3).map(n => `
                    <div class="news-item">
                      <div>${n.title}</div>
                      <div class="muted" style="font-size: 12px;">${n.source} • ${n.ts}</div>
                    </div>
                  `).join("")}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join("");

      wrap.innerHTML = `
        <div id="${carouselId}" class="carousel slide" data-bs-ride="false" data-bs-touch="true">
          <div class="carousel-indicators">${indicators}</div>
          <div class="carousel-inner">${items}</div>
          <button class="carousel-control-prev" type="button" data-bs-target="#${carouselId}" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#${carouselId}" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
            <span class="visually-hidden">Next</span>
          </button>
        </div>
      `;

      // Subscribe WS to these symbols
      subscribedSymbols = latestCards.map(x => x.symbol);
      wsSubscribe(subscribedSymbols);
    }

    async function sendChat() {
      const input = document.getElementById("chatInput");
      const msg = (input.value || "").trim();
      if (!msg) return;

      document.getElementById("assistantText").textContent = "Thinking…";
      input.value = "";

      const res = await fetch("/api/chat", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ message: msg })
      });

      const data = await res.json();
      document.getElementById("assistantText").textContent = data.assistant || "";
      renderCarousel(data.cards || []);
    }

    async function order(symbol, side) {
      const res = await fetch("/api/order", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ symbol, side, qty: 1 })
      });
      const data = await res.json();
      toast(data.message || data.error || "Unknown response", !!data.ok);
    }

    function wsConnect() {
      const status = document.getElementById("wsStatus");
      const proto = location.protocol === "https:" ? "wss" : "ws";
      ws = new WebSocket(`${proto}://${location.host}/ws/prices`);

      ws.onopen = () => {
        status.textContent = "WS: connected";
        status.className = "chip";
        if (subscribedSymbols.length) wsSubscribe(subscribedSymbols);
      };

      ws.onclose = () => {
        status.textContent = "WS: disconnected";
        status.className = "chip";
        setTimeout(wsConnect, 800);
      };

      ws.onerror = () => {
        status.textContent = "WS: error";
        status.className = "chip";
      };

      ws.onmessage = (ev) => {
        const msg = JSON.parse(ev.data);
        if (msg.type === "tick") {
          const snap = msg.data || {};
          // Update only the visible carousel fields
          for (const sym of Object.keys(snap)) {
            const p = snap[sym];
            const fields = ["ltp", "change", "change_pct", "day_high", "day_low", "vol"];
            for (const k of fields) {
              const el = document.querySelector(`[data-sym="${sym}"][data-k="${k}"]`);
              if (el) el.textContent = fmt(p[k]);
            }
          }
        }
      };
    }

    function wsSubscribe(symbols) {
      if (!ws || ws.readyState !== 1) return;
      ws.send(JSON.stringify({ type: "subscribe", symbols }));
    }

    document.getElementById("sendBtn").addEventListener("click", sendChat);
    document.getElementById("chatInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendChat();
    });

    wsConnect();
  </script>
</body>
</html>
